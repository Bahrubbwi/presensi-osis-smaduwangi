<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Presensi OSIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        #preview-container { display: none; text-align: center; margin-top: 10px; }
        #preview-image { max-width: 100%; border-radius: 10px; border: 2px solid #ddd; }
        .gps-container { display: flex; gap: 5px; align-items: center; margin-bottom: 15px; }
        .status-box { flex-grow: 1; padding: 10px; border-radius: 8px; font-size: 0.9em; text-align: center; margin-bottom: 0 !important; }
        .btn-refresh-gps { height: 42px; width: 50px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .status-ok { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .status-error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        
        /* STYLE POPUP FOTO */
        #modalFoto { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; }
        #imgFull { max-width: 95%; max-height: 80%; border-radius: 5px; box-shadow: 0 0 20px white; object-fit: contain; }
        .btn-close-modal { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; background: none; border: none; z-index: 10000; }
        .btn-download-img { margin-top: 15px; padding: 10px 20px; background: #28a745; color: white; border-radius: 5px; text-decoration: none; }

        .table-responsive { max-height: 400px; font-size: 0.85rem; }
        @media print {
            body { background-color: white; } .no-print { display: none !important; } #login-page, #presensi-page { display: none !important; }
            #admin-page { display: block !important; position: absolute; top: 0; left: 0; width: 100%; border: none; }
            .table-responsive { max-height: none; overflow: visible; } .card { box-shadow: none; border: none; }
            #kop-laporan { display: block !important; text-align: center; margin-bottom: 20px; border-bottom: 2px solid black; padding-bottom: 10px; }
        }
        #kop-laporan { display: none; }
    </style>
</head>
<body>

<div id="modalFoto">
    <button class="btn-close-modal" onclick="tutupFoto()">√ó</button>
    <img id="imgFull" src="" alt="Foto Bukti">
    <a id="linkDownload" href="#" target="_blank" class="btn-download-img"><i class="fas fa-external-link-alt"></i> Buka Asli</a>
</div>

<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-12 col-lg-6">
            
            <div id="login-page" class="card p-4">
                <div class="text-center mb-4"><h3>üîê LOGIN OSIS</h3><p class="text-muted small">SMKN DARUL ULUM MUNCAR</p></div>
                <form id="loginForm">
                    <div class="mb-3"><label>Username</label><input type="text" class="form-control" id="loginUser" required placeholder="User"></div>
                    <div class="mb-3"><label>Password</label><input type="password" class="form-control" id="loginPass" required placeholder="Pass"></div>
                    <button type="submit" id="btnLogin" class="btn btn-primary w-100 py-2">MASUK</button>
                    <div id="loginLoading" class="text-center mt-3 small text-primary hidden">Sedang memeriksa akun...</div>
                </form>
            </div>

            <div id="presensi-page" class="card p-4 hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">üìç Form Presensi</h5>
                    <button onclick="logout()" class="btn btn-sm btn-outline-danger">Keluar</button>
                </div>
                <div class="alert alert-info py-2 small">Halo, <b id="displayNama">User</b>!<br>Posisi: <span id="displayJabatan">Anggota</span></div>
                
                <div class="gps-container">
                    <div id="status-info" class="status-box status-error">Memuat GPS...</div>
                    <button type="button" onclick="refreshGPS()" class="btn btn-warning btn-refresh-gps" title="Refresh Lokasi"><i class="fas fa-sync-alt"></i></button>
                </div>

                <form id="presensiForm">
                    <input type="hidden" id="nama"><input type="hidden" id="jabatan">
                    <div class="row mb-3">
                        <div class="col-6"><label class="small text-muted">Tanggal</label><input type="date" class="form-control" id="tanggal" readonly></div>
                        <div class="col-6"><label class="small text-muted">Jam</label><input type="time" class="form-control" id="jam" readonly></div>
                    </div>
                    
                    <div class="mb-3"><label>Jenis Kegiatan</label><select class="form-select" id="jenisKegiatan" required><option value="" selected disabled>Memuat kegiatan...</option></select></div>
                    <div class="mb-3"><label>Keterangan</label><div class="d-flex gap-3"><div class="form-check"><input class="form-check-input" type="radio" name="ket" value="Hadir" checked><label class="form-check-label">Hadir</label></div><div class="form-check"><input class="form-check-input" type="radio" name="ket" value="Izin"><label class="form-check-label">Izin</label></div></div></div>
                    
                    <div class="mb-3"><label class="fw-bold">Upload Selfie</label><input type="file" class="form-control" id="fotoInput" accept="image/*" capture="user" required><div id="preview-container"><img id="preview-image" src="#" alt="Preview"></div></div>
                    
                    <button type="submit" class="btn btn-primary w-100 py-2" id="btnKirim" disabled>Menunggu GPS...</button>
                </form>
                <div id="loading" class="text-center mt-3 hidden"><div class="spinner-border text-primary" role="status"></div><p class="small mt-2">Mengirim...</p></div>
            </div>

            <div id="admin-page" class="card p-3 hidden">
                <div id="kop-laporan"><h3>LAPORAN HARIAN PRESENSI OSIS</h3><h4>SMKN DARUL ULUM MUNCAR BANYUWANGI</h4><p class="small">Dicetak: <span id="tglCetak"></span></p></div>
                
                <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                    <h5 class="mb-0 text-primary">üõ°Ô∏è Admin</h5>
                    <div>
                        <button onclick="downloadLaporan()" class="btn btn-sm btn-success me-1"><i class="fas fa-file-excel"></i> Export</button>
                        <button onclick="window.print()" class="btn btn-sm btn-warning me-1"><i class="fas fa-print"></i> Cetak</button>
                        <button onclick="logout()" class="btn btn-sm btn-outline-danger">Keluar</button>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mb-3 no-print">
                    <button onclick="bukaModalKelolaAnggota()" class="btn btn-sm btn-primary flex-fill"><i class="fas fa-users"></i> Anggota</button>
                    <button onclick="bukaModalKelolaKegiatan()" class="btn btn-sm btn-secondary flex-fill"><i class="fas fa-list"></i> Kegiatan</button>
                    <button onclick="loadLaporan()" class="btn btn-sm btn-info flex-fill text-white"><i class="fas fa-sync"></i> Refresh</button>
                </div>

                <div class="input-group mb-2 no-print">
                    <span class="input-group-text bg-white"><i class="fas fa-calendar-alt"></i></span>
                    <input type="date" id="filterTanggalAdmin" class="form-control">
                    <button class="btn btn-primary" onclick="loadLaporan('filter')"><i class="fas fa-search"></i> Cari</button>
                    <button class="btn btn-outline-secondary" onclick="resetFilter()"><i class="fas fa-times"></i></button>
                </div>

                <div class="table-responsive border rounded">
                    <table class="table table-striped table-hover mb-0"><thead class="table-dark"><tr><th>Waktu</th><th>Nama</th><th>Kegiatan</th><th class="no-print">Foto</th></tr></thead><tbody id="tabelLaporan"><tr><td colspan="4" class="text-center p-3">Memuat...</td></tr></tbody></table>
                </div>
                <div class="mt-5 text-end d-none d-print-block"><p>Mengetahui,<br>Pembina OSIS</p><br><br><br><p>_______________________</p></div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalKelolaAnggota" tabindex="-1"><div class="modal-dialog modal-fullscreen-sm-down"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Data Anggota</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="d-flex gap-2 mb-3"><button onclick="bukaFormAnggota('tambah')" class="btn btn-light border flex-fill"><i class="fas fa-plus"></i> Manual</button><button onclick="document.getElementById('fileExcel').click()" class="btn btn-success flex-fill"><i class="fas fa-file-excel"></i> Import Excel</button><input type="file" id="fileExcel" style="display:none" onchange="prosesImportExcel(this)"></div><div class="alert alert-warning small py-1">Format Excel (Tanpa Header):<br>A: User | B: Pass | C: Nama | D: Jabatan</div><div class="table-responsive border rounded" style="max-height: 50vh;"><table class="table table-sm table-striped"><thead class="table-light"><tr><th>Nama/User</th><th>Jab</th><th>Aksi</th></tr></thead><tbody id="tabelAnggota"><tr><td colspan="3" class="text-center">Memuat...</td></tr></tbody></table></div></div></div></div></div>
<div class="modal fade" id="modalFormAnggota" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="judulFormAnggota">Anggota</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formAnggota"><input type="hidden" id="modeForm"><input type="hidden" id="usernameLama"><div class="mb-2"><label>Username</label><input type="text" class="form-control" id="inputUser" required></div><div class="mb-2"><label>Password</label><input type="text" class="form-control" id="inputPass" required></div><div class="mb-2"><label>Nama</label><input type="text" class="form-control" id="inputNama" required></div><div class="mb-2"><label>Jabatan</label><select class="form-select" id="inputJabatan" required><option value="Ketua">Ketua</option><option value="Wakil">Wakil</option><option value="Sekretaris">Sekretaris</option><option value="Bendahara">Bendahara</option><option value="Anggota">Anggota</option><option value="Pembina">Pembina</option></select></div><button type="submit" class="btn btn-primary w-100 mt-3" id="btnSimpanAnggota">Simpan</button></form></div></div></div></div>
<div class="modal fade" id="modalKelolaKegiatan" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-secondary text-white"><h5 class="modal-title">Daftar Kegiatan</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="input-group mb-3"><input type="text" class="form-control" id="inputKegiatanBaru" placeholder="Nama Kegiatan Baru"><button class="btn btn-success" onclick="tambahKegiatan()">Tambah</button></div><ul class="list-group" id="listKegiatan"><li class="list-group-item text-center">Memuat...</li></ul></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ==========================================
    // --- KONFIGURASI (WAJIB DIISI ULANG) ---
    // ==========================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwXxARx4uP9z0xhbBPf6dHSDrAZuWPh4z3lOW-hQbT8pUHcY0i71bHgqZ1tDXqhMPDh/exec'; 
    
    const LAT_SEKOLAH = -8.481473507725331;   
    const LNG_SEKOLAH = 114.33357576924877;  
    const MAX_JARAK_METER = 800; 
    // ==========================================
    
    let userLat, userLng, jarakMeter, base64Foto, modalKelola, modalForm, modalKegiatan;
    let watchId = null;

    if(localStorage.getItem('osis_nama')) cekHalamanTujuan(localStorage.getItem('osis_nama'), localStorage.getItem('osis_jabatan'));

    // --- POPUP FOTO LOGIC (ANTI BLOKIR) ---
    function bukaFoto(url) {
        document.getElementById('imgFull').src = "https://i.gifer.com/ZKZg.gif"; 
        document.getElementById('linkDownload').href = url;
        document.getElementById('modalFoto').style.display = "flex";

        let fileId = "";
        let match1 = url.match(/\/d\/(.+?)(\/|$)/);
        let match2 = url.match(/id=(.+?)($|&)/);
        if (match1) fileId = match1[1]; else if (match2) fileId = match2[1];

        if (fileId) {
            let directLink = "https://lh3.googleusercontent.com/d/" + fileId;
            document.getElementById('imgFull').src = directLink;
        } else { document.getElementById('imgFull').src = url; }
    }
    function tutupFoto() { document.getElementById('modalFoto').style.display = "none"; document.getElementById('imgFull').src = ""; }

    // --- GPS REFRESH & LOGIC ---
    function refreshGPS() {
        const info = document.getElementById('status-info'); const btn = document.getElementById('btnKirim');
        info.innerHTML = 'üîÑ Mencari ulang...'; info.className = 'status-box status-error'; btn.disabled = true; btn.innerText = 'Menunggu GPS...';
        if (watchId) navigator.geolocation.clearWatch(watchId);
        if (navigator.geolocation) navigator.geolocation.getCurrentPosition((pos) => { updateLokasi(pos); startWatchGPS(); }, (err) => { info.innerHTML = '‚ö†Ô∏è Gagal Refresh.'; startWatchGPS(); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    }
    function startWatchGPS() { if (navigator.geolocation) watchId = navigator.geolocation.watchPosition(updateLokasi, (e) => { document.getElementById('status-info').innerHTML = "‚ö†Ô∏è Hilang Sinyal GPS"; }, { enableHighAccuracy: true, maximumAge: 0 }); }
    function updateLokasi(pos) {
        userLat = pos.coords.latitude; userLng = pos.coords.longitude;
        const R=6371e3, œÜ1=userLat*Math.PI/180, œÜ2=LAT_SEKOLAH*Math.PI/180, ŒîœÜ=(LAT_SEKOLAH-userLat)*Math.PI/180, ŒîŒª=(LNG_SEKOLAH-userLng)*Math.PI/180;
        const a=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
        jarakMeter=Math.floor(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
        const info = document.getElementById('status-info'), btn = document.getElementById('btnKirim');
        let ok = jarakMeter <= MAX_JARAK_METER;
        if (ok) { info.innerHTML = `‚úÖ Aman: ${jarakMeter}m`; info.className = "status-box status-ok"; btn.disabled = false; btn.innerText = "Kirim Presensi"; btn.classList.remove('btn-secondary'); btn.classList.add('btn-primary'); } 
        else { info.innerHTML = `‚ùå Jarak: ${jarakMeter}m (Max ${MAX_JARAK_METER}m)`; info.className = "status-box status-error"; btn.disabled = true; btn.innerText = "Jarak Terlalu Jauh"; }
    }
    function mulaiSistemPresensi() {
        setInterval(() => { const n=new Date(); document.getElementById('tanggal').value=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`; document.getElementById('jam').value=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; }, 1000);
        startWatchGPS(); loadKegiatanDropdown(); 
    }

    // --- ADMIN FUNCTIONS ---
    function loadKegiatanDropdown() { fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getKegiatan' }) }).then(res => res.json()).then(d => { let html = '<option value="" selected disabled>Pilih Kegiatan...</option>'; if(d.result === 'success') d.data.forEach(r => { html += `<option value="${r[0]}">${r[0]}</option>`; }); document.getElementById('jenisKegiatan').innerHTML = html; }); }
    function bukaModalKelolaKegiatan() { if(!modalKegiatan) modalKegiatan = new bootstrap.Modal(document.getElementById('modalKelolaKegiatan')); modalKegiatan.show(); loadListKegiatanAdmin(); }
    function loadListKegiatanAdmin() { fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getKegiatan' }) }).then(res => res.json()).then(d => { let html = ''; if(d.result === 'success') d.data.forEach(r => { html += `<li class="list-group-item d-flex justify-content-between align-items-center">${r[0]} <button class="btn btn-sm btn-danger" onclick="hapusKegiatan('${r[0]}')"><i class="fas fa-trash"></i></button></li>`; }); document.getElementById('listKegiatan').innerHTML = html || '<li class="list-group-item text-center">Belum ada kegiatan</li>'; }); }
    function tambahKegiatan() { let nama = document.getElementById('inputKegiatanBaru').value; if(!nama) return alert("Isi nama!"); fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'tambahKegiatan', namaKegiatan: nama }) }).then(res => res.json()).then(d => { if(d.result==='success') { document.getElementById('inputKegiatanBaru').value=''; loadListKegiatanAdmin(); loadKegiatanDropdown(); } }); }
    function hapusKegiatan(nama) { if(!confirm("Hapus?")) return; fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'hapusKegiatan', namaKegiatan: nama }) }).then(res => res.json()).then(d => { if(d.result==='success') { loadListKegiatanAdmin(); loadKegiatanDropdown(); } }); }
    
    function loadLaporan(mode = '') {
        const tbody = document.getElementById('tabelLaporan'); tbody.innerHTML = '<tr><td colspan="4" class="text-center p-3">Memuat...</td></tr>';
        let payload = { action: 'getLaporan' };
        if (mode === 'filter') { const tgl = document.getElementById('filterTanggalAdmin').value; if (tgl) payload.filterTanggal = tgl; else { alert("Pilih tanggal!"); return; } }
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) }).then(res => res.json()).then(data => {
            let html = '';
            if (data.data && data.data.length > 0) {
                data.data.forEach(row => {
                    let tglStr = new Date(row[1]).toLocaleDateString('id-ID', {day:'numeric', month:'short'});
                    html += `<tr><td><b>${tglStr}</b><br><small>${row[2]}</small></td><td>${row[3]}<br><span class="badge bg-secondary badge-ket">${row[4]}</span></td><td>${row[5]}</td>
                    <td class="no-print">
                        <button onclick="bukaFoto('${row[8]}')" class="btn btn-sm btn-primary mb-1"><i class="fas fa-camera"></i></button> 
                    </td></tr>`;
                });
                tbody.innerHTML = html;
            } else { tbody.innerHTML = '<tr><td colspan="4" class="text-center p-3 text-muted">Kosong.</td></tr>'; }
        });
    }
    function resetFilter() { document.getElementById('filterTanggalAdmin').value = ''; loadLaporan(); }
    function downloadLaporan() { if(!confirm("Download SEMUA?")) return; fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getLaporan', mode: 'semua' }) }).then(res => res.json()).then(data => { if(data.result === 'success' && data.data.length > 0) { const dataExcel = data.data.map(row => ({ "Tanggal": new Date(row[1]).toLocaleDateString('id-ID'), "Jam": row[2], "Nama": row[3], "Jabatan": row[4], "Kegiatan": row[5], "Keterangan": row[6], "Lokasi": row[7], "Foto": row[8] })); const ws = XLSX.utils.json_to_sheet(dataExcel); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Laporan"); XLSX.writeFile(wb, "Laporan_Presensi.xlsx"); } else { alert("Kosong!"); } }); }

    // --- IMPORT & ANGGOTA ---
    function prosesImportExcel(input) { const file = input.files[0]; if(!file) return; if(!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) { alert("Salah format!"); input.value = ''; return; } const reader = new FileReader(); reader.onload = function(e) { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}); let dataClean = []; jsonData.forEach(row => { if(row[0]&&row[1]&&row[2]) dataClean.push([row[0],row[1],row[2],row[3]||'Anggota']); }); if(dataClean.length===0){alert("Kosong!");return;} if(!confirm(`Import ${dataClean.length} data?`)) return; fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'importAnggota',dataImport:dataClean})}).then(r=>r.json()).then(d=>{if(d.result==='success'){alert(`‚úÖ Sukses: ${d.jumlah}`);loadDaftarAnggota();}else alert("Gagal: "+d.error);input.value='';}); }; reader.readAsArrayBuffer(file); }
    document.getElementById('loginForm').addEventListener('submit', e=>{ e.preventDefault(); document.getElementById('btnLogin').disabled=true; fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'login',username:document.getElementById('loginUser').value,password:document.getElementById('loginPass').value})}).then(r=>r.json()).then(d=>{ if(d.result==='success'){ localStorage.setItem('osis_nama',d.nama); localStorage.setItem('osis_jabatan',d.jabatan); cekHalamanTujuan(d.nama,d.jabatan); } else alert(d.error); document.getElementById('btnLogin').disabled=false; }); });
    function cekHalamanTujuan(n, j) { document.getElementById('login-page').classList.add('hidden'); if(j==='Pembina'){ document.getElementById('admin-page').classList.remove('hidden'); document.getElementById('tglCetak').innerText=new Date().toLocaleDateString(); loadLaporan(); } else { document.getElementById('presensi-page').classList.remove('hidden'); document.getElementById('displayNama').innerText=n; document.getElementById('displayJabatan').innerText=j; document.getElementById('nama').value=n; document.getElementById('jabatan').value=j; mulaiSistemPresensi(); } }
    function logout(){ localStorage.clear(); window.location.reload(); }
    function bukaModalKelolaAnggota(){ if(!modalKelola) modalKelola=new bootstrap.Modal(document.getElementById('modalKelolaAnggota')); modalKelola.show(); loadDaftarAnggota(); }
    function loadDaftarAnggota(){ document.getElementById('tabelAnggota').innerHTML='<tr><td colspan="3" class="text-center">Memuat...</td></tr>'; fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'getAnggota'})}).then(r=>r.json()).then(d=>{ let h=''; d.data.forEach(r=>{ h+=`<tr><td>${r[2]}<br><small class="text-muted">${r[0]}</small></td><td>${r[3]}</td><td><button onclick="bukaFormAnggota('edit','${r[0]}','${r[1]}','${r[2]}','${r[3]}')" class="btn btn-sm btn-warning mb-1"><i class="fas fa-edit"></i></button> <button onclick="hapusAnggota('${r[0]}')" class="btn btn-sm btn-danger mb-1"><i class="fas fa-trash"></i></button></td></tr>`; }); document.getElementById('tabelAnggota').innerHTML=h; }); }
    function bukaFormAnggota(m,u='',p='',n='',j=''){ if(!modalForm) modalForm=new bootstrap.Modal(document.getElementById('modalFormAnggota')); document.getElementById('modeForm').value=m; document.getElementById('judulFormAnggota').innerText=m==='tambah'?'Tambah':'Edit'; document.getElementById('inputUser').value=u; document.getElementById('inputPass').value=p; document.getElementById('inputNama').value=n; document.getElementById('inputJabatan').value=j; document.getElementById('usernameLama').value=u; modalForm.show(); }
    document.getElementById('formAnggota').addEventListener('submit',e=>{ e.preventDefault(); let m=document.getElementById('modeForm').value; let d={action:m==='tambah'?'tambahAnggota':'editAnggota', username:document.getElementById('inputUser').value, password:document.getElementById('inputPass').value, nama:document.getElementById('inputNama').value, jabatan:document.getElementById('inputJabatan').value, usernameLama:document.getElementById('usernameLama').value, usernameBaru:document.getElementById('inputUser').value}; fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(x=>{ if(x.result==='success'){ modalForm.hide(); loadDaftarAnggota(); }else alert(x.error); }); });
    function hapusAnggota(u){ if(confirm("Hapus "+u+"?")) fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'hapusAnggota',username:u})}).then(r=>r.json()).then(d=>{if(d.result==='success')loadDaftarAnggota();}); }
    
    // --- FUNGSI KOMPRES GAMBAR & WATERMARK (UPDATED) ---
    document.getElementById('fotoInput').addEventListener('change', function(e) {
        let f = e.target.files[0];
        if (f) {
            let r = new FileReader();
            r.onload = function(ev) {
                let i = new Image();
                i.onload = function() {
                    let c = document.createElement('canvas');
                    let x = c.getContext('2d');
                    let w = i.width, h = i.height, mw = 1000;
                    if (w > mw) { h *= mw / w; w = mw; }
                    c.width = w; c.height = h;
                    x.drawImage(i, 0, 0, w, h);
                    let barHeight = h * 0.15; if(barHeight < 60) barHeight = 60;
                    x.fillStyle = "rgba(0,0,0,0.6)"; x.fillRect(0, h - barHeight, w, barHeight);
                    let fontSize = w * 0.04; if(fontSize < 14) fontSize = 14;
                    x.fillStyle = "white"; x.font = "bold " + fontSize + "px Arial";
                    let namaSiswa = document.getElementById('nama').value || "Siswa";
                    let waktu = new Date().toLocaleString('id-ID');
                    let lokasi = (userLat && userLng) ? `Lat: ${userLat.toFixed(5)}, Lng: ${userLng.toFixed(5)}` : "Mencari Lokasi...";
                    let textX = 15;
                    let line1Y = h - barHeight + (barHeight/3);
                    let line2Y = h - barHeight + (barHeight/1.2);
                    x.fillText(namaSiswa + " | " + waktu, textX, line1Y);
                    x.fillText(lokasi, textX, line2Y);
                    document.getElementById('preview-image').src = c.toDataURL('image/jpeg', 0.8);
                    document.getElementById('preview-container').style.display = 'block';
                    base64Foto = c.toDataURL('image/jpeg', 0.8).split(',')[1];
                };
                i.src = ev.target.result;
            };
            r.readAsDataURL(f);
        }
    });
    
    // SUBMIT ABSEN (TANPA TTD)
    document.getElementById('presensiForm').addEventListener('submit',e=>{ 
        e.preventDefault(); 
        if(!base64Foto) return alert("Foto Wajib!");
        document.getElementById('btnKirim').disabled=true;
        document.getElementById('loading').style.display='block';
        let d={action:'absen',tanggal:document.getElementById('tanggal').value,jam:document.getElementById('jam').value,nama:document.getElementById('nama').value,jabatan:document.getElementById('jabatan').value,jenisKegiatan:document.getElementById('jenisKegiatan').value,keterangan:document.querySelector('input[name="ket"]:checked').value,lokasi:userLat+", "+userLng,fotoBase64:base64Foto,fotoMimeType:'image/jpeg'};
        fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(x=>{if(x.result==='success'){alert("Sukses!");window.location.reload();}else alert(x.error);document.getElementById('btnKirim').disabled=false;});
    });
</script>
</body>
</html>


