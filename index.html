<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
Â  Â  // ============================================
Â  Â  // PERHATIAN: PASTIKAN URL WEB APP ANDA DI SINI
Â  Â  // ============================================
Â  Â  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwXxARx4uP9z0xhbBPf6dHSDrAZuWPh4z3lOW-hQbT8pUHcY0i71bHgqZ1tDXqhMPDh/exec'; // <--- GANTI JIKA URL ANDA BERUBAH!
Â  Â Â 
Â  Â  // CONFIG LOKASI SEKOLAH
Â  Â  const LAT_SEKOLAH = -8.481473507725331;Â 
Â  Â  const LNG_SEKOLAH = 114.33357576924877;Â 
Â  Â  const MAX_JARAK_METER = 800;Â 

Â  Â  // VARIABEL GLOBAL
Â  Â  let userLat, userLng, jarakMeter, base64Foto, modalKelola, modalForm, modalKegiatan, modalHapus, modalExport;
    
    // --- FUNGSI KEAMANAN: SHA-256 HASHING (ASYNC) ---
    async function hashSHA256(str) {
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        // Menggunakan Web Crypto API untuk hashing
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        // Konversi ke heksadesimal
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

Â  Â  // --- FUNGSI UPDATE TANGGAL & JAM (FIX) ---
Â  Â  function updateWaktu() {
Â  Â  Â  Â  const n = new Date();
Â  Â  Â  Â  const tglField = document.getElementById('tanggal');
Â  Â  Â  Â  const jamField = document.getElementById('jam');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const yyyy = n.getFullYear();
Â  Â  Â  Â  const mm = String(n.getMonth() + 1).padStart(2, '0');
Â  Â  Â  Â  const dd = String(n.getDate()).padStart(2, '0');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const hh = String(n.getHours()).padStart(2, '0');
Â  Â  Â  Â  const min = String(n.getMinutes()).padStart(2, '0');

Â  Â  Â  Â  if(tglField) tglField.value = `${yyyy}-${mm}-${dd}`;
Â  Â  Â  Â  if(jamField) jamField.value = `${hh}:${min}`;
Â  Â  }
Â  Â  // ---------------------------------------------
Â  Â Â 
Â  Â  // Panggil fungsi waktu secara langsung dan set interval
Â  Â  updateWaktu();Â 
Â  Â  setInterval(updateWaktu, 1000);
Â  Â Â 
Â  Â  if(localStorage.getItem('osis_nama')) cekHalamanTujuan(localStorage.getItem('osis_nama'), localStorage.getItem('osis_jabatan'), localStorage.getItem('osis_kelas'));

Â  Â  // FETCH AMAN
Â  Â  async function fetchData(data) {
Â  Â  Â  Â  return fetch(SCRIPT_URL, {Â 
Â  Â  Â  Â  Â  Â  method: 'POST',Â 
Â  Â  Â  Â  Â  Â  redirect: 'follow',Â 
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "text/plain;charset=utf-8" },Â 
Â  Â  Â  Â  Â  Â  body: JSON.stringify(data)Â 
Â  Â  Â  Â  }).then(response => response.json());
Â  Â  }

Â  Â  // PHOTO & GPS
Â  Â  function bukaFoto(url) { document.getElementById('imgFull').src = "https://i.gifer.com/ZKZg.gif"; document.getElementById('linkDownload').href = url; document.getElementById('modalFoto').style.display = "flex"; let fileId = url.match(/id=(.+?)($|&)/) || url.match(/\/d\/(.+?)(\/|$)/); if (fileId) document.getElementById('imgFull').src = "https://lh3.googleusercontent.com/d/" + fileId[1]; else document.getElementById('imgFull').src = url; }
Â  Â  function tutupFoto() { document.getElementById('modalFoto').style.display = "none"; document.getElementById('imgFull').src = ""; }
Â  Â Â 
Â  Â  function refreshGPS() {
Â  Â  Â  Â  const info = document.getElementById('status-info'); const btn = document.getElementById('btnKirim'); info.innerHTML = 'ğŸ”„ Mencari ulang...'; info.className = 'status-box status-error'; btn.disabled = true; btn.innerText = 'Menunggu GPS...';
Â  Â  Â  Â  if (navigator.geolocation) navigator.geolocation.getCurrentPosition((pos) => { updateLokasi(pos); }, () => { info.innerHTML = 'âš ï¸ Gagal GPS'; }, { enableHighAccuracy: true });
Â  Â  }
Â  Â  function updateLokasi(pos) {
Â  Â  Â  Â  userLat = pos.coords.latitude; userLng = pos.coords.longitude;
Â  Â  Â  Â  const R=6371e3, Ï†1=userLat*Math.PI/180, Ï†2=LAT_SEKOLAH*Math.PI/180, Î”Ï†=(LAT_SEKOLAH-userLat)*Math.PI/180, Î”Î»=(LNG_SEKOLAH-userLng)*Math.PI/180;
Â  Â  Â  Â  const a=Math.sin(Î”Ï†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
Â  Â  Â  Â  jarakMeter=Math.floor(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
Â  Â  Â  Â  const info = document.getElementById('status-info'), btn = document.getElementById('btnKirim');
Â  Â  Â  Â  if (jarakMeter <= MAX_JARAK_METER) { info.innerHTML = `âœ… Aman: ${jarakMeter}m`; info.className = "status-box status-ok"; btn.disabled = false; btn.innerText = "Kirim Presensi"; btn.classList.remove('btn-secondary'); btn.classList.add('btn-primary'); }Â 
Â  Â  Â  Â  else { info.innerHTML = `âŒ Jarak: ${jarakMeter}m`; info.className = "status-box status-error"; btn.disabled = true; btn.innerText = "Jarak Terlalu Jauh"; }
Â  Â  }
Â  Â Â 
Â  Â  refreshGPS();Â 
Â  Â  loadKegiatanDropdown();Â 

Â  Â  // ADMIN - LOAD DATA
Â  Â  function loadLaporan(mode = '') {
Â  Â  Â  Â  const tbody = document.getElementById('tabelLaporan'), divRekap = document.getElementById('rekap-kegiatan');Â 
Â  Â  Â  Â  tbody.innerHTML = '<tr><td colspan="7" class="text-center p-3">Memuat...</td></tr>'; divRekap.innerHTML = ''; divRekap.className = 'row g-2 mb-3';Â 
Â  Â  Â  Â  let payload = { action: 'getLaporan' };
Â  Â  Â  Â  if (mode === 'filter') { const tgl = document.getElementById('filterTanggalAdmin').value; if (tgl) payload.filterTanggal = tgl; else { Swal.fire('Info', 'Pilih tanggal dulu!', 'info'); return; } }
Â  Â  Â  Â  fetchData(payload).then(data => {
Â  Â  Â  Â  Â  Â  let html = '', counts = {};Â 
Â  Â  Â  Â  Â  Â  if (data.data && data.data.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  data.data.forEach((row, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let jam = String(row[2]).includes('T') ? new Date(row[2]).toLocaleTimeString('id-ID', {hour:'2-digit',minute:'2-digit'}).replace('.', ':') : row[2];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let keg = row[6]; if (counts[keg]) counts[keg]++; else counts[keg] = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let tgl = new Date(row[1]).toLocaleDateString('id-ID', {day:'numeric', month:'short'});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<tr><td>${i+1}</td><td class="small text-muted">${row[10]||'-'}</td><td><b>${tgl}</b><br><small>${jam}</small></td><td>${row[3]}</td><td>${row[4]}</td><td>${row[6]}<br><small class="text-success">${row[7]}</small></td><td class="no-print"><button onclick="bukaFoto('${row[9]}')" class="btn btn-sm btn-primary"><i class="fas fa-camera"></i></button></td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML = html;
Â  Â  Â  Â  Â  Â  Â  Â  let hRekap = ''; for (const [k, v] of Object.entries(counts)) { let c = ['primary', 'success', 'danger', 'warning'][Math.floor(Math.random() * 4)]; hRekap += `<div class="col-6 col-sm-4 col-md-3"><div class="p-2 border rounded bg-white shadow-sm d-flex justify-content-between align-items-center border-start border-4 border-${c}"><span class="small fw-bold text-secondary text-truncate me-2">${k}</span><span class="badge bg-${c} rounded-pill">${v}</span></div></div>`; } divRekap.innerHTML = hRekap;
Â  Â  Â  Â  Â  Â  } else { tbody.innerHTML = '<tr><td colspan="7" class="text-center p-3 text-muted">Kosong.</td></tr>'; }
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  // --- LOGIKA EXPORT & CETAK CANGGIH (FITUR BARU) ---
Â  Â  function bukaModalExport() {
Â  Â  Â  Â  if (!modalExport) modalExport = new bootstrap.Modal(document.getElementById('modalExportOptions'));
Â  Â  Â  Â  fetchData({ action: 'getKegiatan' }).then(d => {
Â  Â  Â  Â  Â  Â  let html = '<option value="" selected disabled>Pilih Kegiatan...</option>';
Â  Â  Â  Â  Â  Â  if(d.result === 'success') d.data.forEach(r => { html += `<option value="${r[0]}">${r[0]}</option>`; });
Â  Â  Â  Â  Â  Â  document.getElementById('inputExportKegiatan').innerHTML = html;
Â  Â  Â  Â  });
Â  Â  Â  Â  modalExport.show();
Â  Â  }
Â  Â  function cekOpsiExport() {
Â  Â  Â  Â  let jenis = document.getElementById('jenisFilterExport').value;
Â  Â  Â  Â  document.getElementById('opsiExportTanggal').classList.toggle('hidden', jenis !== 'tanggal');
Â  Â  Â  Â  document.getElementById('opsiExportKegiatan').classList.toggle('hidden', jenis !== 'kegiatan');
Â  Â  }
Â  Â  function eksekusiLaporan(tipe) {
Â  Â  Â  Â  let jenis = document.getElementById('jenisFilterExport').value;
Â  Â  Â  Â  let payload = { action: 'getLaporan', mode: 'semua' };
Â  Â  Â  Â  if (jenis === 'tanggal') {
Â  Â  Â  Â  Â  Â  let tgl = document.getElementById('inputExportTanggal').value;
Â  Â  Â  Â  Â  Â  if (!tgl) return Swal.fire('Error', 'Pilih tanggal!', 'warning');
Â  Â  Â  Â  Â  Â  payload = { action: 'getLaporan', filterTanggal: tgl };
Â  Â  Â  Â  } else if (jenis === 'kegiatan') {
Â  Â  Â  Â  Â  Â  let keg = document.getElementById('inputExportKegiatan').value;
Â  Â  Â  Â  Â  Â  if (!keg) return Swal.fire('Error', 'Pilih kegiatan!', 'warning');
Â  Â  Â  Â  Â  Â  payload = { action: 'getLaporan', filterKegiatan: keg };
Â  Â  Â  Â  }
Â  Â  Â  Â  Swal.fire({title:'Memproses...', didOpen:()=>{Swal.showLoading()}});
Â  Â  Â  Â  fetchData(payload).then(data => {
Â  Â  Â  Â  Â  Â  Swal.close();
Â  Â  Â  Â  Â  Â  if (data.result !== 'success' || data.data.length === 0) return Swal.fire('Kosong', 'Tidak ada data.', 'info');
Â  Â  Â  Â  Â  Â  if (tipe === 'print') {
Â  Â  Â  Â  Â  Â  Â  Â  // RENDER ULANG TABEL UNTUK PRINT
Â  Â  Â  Â  Â  Â  Â  Â  const tbody = document.getElementById('tabelLaporan'); let html = '';
Â  Â  Â  Â  Â  Â  Â  Â  data.data.forEach((row, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let jam = String(row[2]).includes('T') ? new Date(row[2]).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}).replace('.', ':') : row[2];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let tgl = new Date(row[1]).toLocaleDateString('id-ID', {day:'numeric', month:'short'});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<tr><td>${i+1}</td><td class="small text-muted">${row[10]||'-'}</td><td><b>${tgl}</b><br><small>${jam}</small></td><td>${row[3]}</td><td>${row[4]}</td><td>${row[6]}<br><small class="text-success">${row[7]}</small></td><td class="no-print"></td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML = html;
Â  Â  Â  Â  Â  Â  Â  Â  modalExport.hide(); setTimeout(() => { window.print(); loadLaporan(); }, 500);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const dataExcel = data.data.map(row => ({ "Username":row[10], "Tanggal":new Date(row[1]).toLocaleDateString('id-ID'), "Jam":row[2], "Nama":row[3], "Kelas":row[4], "Jabatan":row[5], "Kegiatan":row[6], "Keterangan":row[7], "Lokasi":row[8], "Foto":row[9] }));
Â  Â  Â  Â  Â  Â  Â  Â  const ws = XLSX.utils.json_to_sheet(dataExcel); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Laporan"); XLSX.writeFile(wb, "Laporan_Presensi.xlsx");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- MODAL LOGIC (Hapus & Lainnya) ---
Â  Â  function bukaModalHapus() { if (!modalHapus) modalHapus = new bootstrap.Modal(document.getElementById('modalHapusMassal')); fetchData({ action: 'getKegiatan' }).then(d => { let h = '<option value="" selected disabled>Pilih...</option>'; d.data.forEach(r => { h += `<option value="${r[0]}">${r[0]}</option>`; }); document.getElementById('targetHapusKegiatan').innerHTML = h; }); modalHapus.show(); }
Â  Â  function cekModeHapus() { let m = document.getElementById('modeHapus').value; document.getElementById('blokHapusTanggal').classList.toggle('hidden', m!=='tanggal'); document.getElementById('blokHapusKegiatan').classList.toggle('hidden', m!=='kegiatan'); }
Â  Â  function prosesHapusMassal() { let m = document.getElementById('modeHapus').value; let t = m==='tanggal' ? document.getElementById('targetHapusTanggal').value : document.getElementById('targetHapusKegiatan').value; if(!t) return Swal.fire('Error', 'Pilih target!', 'warning'); Swal.fire({title:'Yakin Hapus?', text:'Permanen!', icon:'warning', showCancelButton:true, confirmButtonText:'Ya, Hapus'}).then((r)=>{ if(r.isConfirmed){ fetchData({ action: 'hapusMassal', mode: m, target: t }).then(d => { if (d.result === 'success') { Swal.fire('Sukses', `Terhapus ${d.jumlah} data.`, 'success'); modalHapus.hide(); loadLaporan(); } else { Swal.fire('Gagal', d.error, 'error'); } }); } }); }

Â  Â  // --- IMPORT, LOGIN, REGISTER ---
Â  Â  function prosesImportExcel(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}); let dataClean = []; jsonData.forEach(row => { if(row[0]&&row[1]&&row[2]) dataClean.push([row[0],row[1],row[2],row[3],row[4]||'-']); }); if(dataClean.length>0 && confirm(`Import ${dataClean.length} data?`)) fetchData({action:'importAnggota',dataImport:dataClean}).then(d=>{if(d.result==='success'){alert(`Sukses: ${d.jumlah}`);loadDaftarAnggota();}else alert("Gagal: "+d.error);input.value='';}); }; reader.readAsArrayBuffer(file); }
    
    // --- LOGIN YANG SUDAH DI-HASH ---
Â  Â  document.getElementById('loginForm').addEventListener('submit', async e=>{ // <--- TAMBAH ASYNC
        e.preventDefault(); 
        document.getElementById('btnLogin').disabled=true; 

        const username = document.getElementById('loginUser').value;
        const password = document.getElementById('loginPass').value;
        const hashedPassword = await hashSHA256(password); // <--- HASH PASSWORD

        fetchData({action:'login',username:username,password:hashedPassword}) // <--- KIRIM HASHED PASSWORD
        .then(d=>{ 
            if(d.result==='success'){ 
                localStorage.setItem('osis_nama',d.nama); 
                localStorage.setItem('osis_jabatan',d.jabatan); 
                localStorage.setItem('osis_kelas',d.kelas); 
                localStorage.setItem('osis_username',d.username); 
                cekHalamanTujuan(d.nama,d.jabatan,d.kelas); 
            } else alert(d.error); 
            document.getElementById('btnLogin').disabled=false; 
        })
        .catch(() => {
            alert('Koneksi atau server gagal merespons.');
            document.getElementById('btnLogin').disabled=false;
        });
    });
    // --- AKHIR LOGIN YANG SUDAH DI-HASH ---

Â  Â  function cekHalamanTujuan(n, j, k) { document.getElementById('login-page').classList.add('hidden'); if(j==='Pembina'){ document.getElementById('admin-page').classList.remove('hidden'); document.getElementById('tglCetak').innerText=new Date().toLocaleDateString(); loadLaporan(); } else { document.getElementById('presensi-page').classList.remove('hidden'); document.getElementById('displayNama').innerText=n; document.getElementById('displayJabatan').innerText=j; document.getElementById('displayKelas').innerText=k; document.getElementById('nama').value=n; document.getElementById('jabatan').value=j; document.getElementById('kelas').value=k; } }
Â  Â  function logout(){ localStorage.clear(); window.location.reload(); }
Â  Â  function bukaModalKelolaAnggota(){ if(!modalKelola) modalKelola=new bootstrap.Modal(document.getElementById('modalKelolaAnggota')); modalKelola.show(); loadDaftarAnggota(); }
Â  Â  function loadDaftarAnggota(){ document.getElementById('tabelAnggota').innerHTML='<tr><td colspan="3" class="text-center">Memuat...</td></tr>'; fetchData({action:'getAnggota'}).then(d=>{ let h=''; d.data.forEach(r=>{ h+=`<tr><td>${r[2]}<br><small class="text-muted">${r[4]}</small></td><td>${r[3]}</td><td><button onclick="bukaFormAnggota('edit','${r[0]}','${r[1]}','${r[2]}','${r[3]}','${r[4]}')" class="btn btn-sm btn-warning">Edit</button> <button onclick="hapusAnggota('${r[0]}')" class="btn btn-sm btn-danger">Hapus</button></td></tr>`; }); document.getElementById('tabelAnggota').innerHTML=h; }); }
Â  Â  function bukaFormAnggota(m,u='',p='',n='',j='',k=''){ if(!modalForm) modalForm=new bootstrap.Modal(document.getElementById('modalFormAnggota')); document.getElementById('modeForm').value=m; document.getElementById('judulFormAnggota').innerText=m==='tambah'?'Tambah':'Edit'; document.getElementById('inputUser').value=u; document.getElementById('inputPass').value=p; document.getElementById('inputNama').value=n; document.getElementById('inputJabatan').value=j; document.getElementById('inputKelas').value=k; document.getElementById('usernameLama').value=u; modalForm.show(); }
    
    // --- SUBMIT FORM ANGGOTA (HASH PASSWORD SEBELUM SIMPAN) ---
Â  Â  document.getElementById('formAnggota').addEventListener('submit', async e=>{ // <--- TAMBAH ASYNC
        e.preventDefault(); 
        let m=document.getElementById('modeForm').value; 
        let password = document.getElementById('inputPass').value;
        const hashedPassword = await hashSHA256(password); // <--- HASH PASSWORD

        let d={action:m==='tambah'?'tambahAnggota':'editAnggota', username:document.getElementById('inputUser').value, password:hashedPassword, // <--- KIRIM HASH
            nama:document.getElementById('inputNama').value, jabatan:document.getElementById('inputJabatan').value, kelas:document.getElementById('inputKelas').value, usernameLama:document.getElementById('usernameLama').value, usernameBaru:document.getElementById('inputUser').value}; 
        fetchData(d).then(x=>{ 
            if(x.result==='success'){ modalForm.hide(); loadDaftarAnggota(); }else alert(x.error); 
        }); 
    });
    // --- AKHIR SUBMIT FORM ANGGOTA ---
    
Â  Â  function hapusAnggota(u){ if(confirm("Hapus?")) fetchData({action:'hapusAnggota',username:u}).then(d=>{if(d.result==='success')loadDaftarAnggota();}); }
Â  Â  function loadKegiatanDropdown() {Â 
Â  Â  Â  Â  fetchData({ action: 'getKegiatan' }).then(d => {Â 
Â  Â  Â  Â  Â  Â  let html = '<option value="" selected disabled>Pilih...</option>';Â 
Â  Â  Â  Â  Â  Â  if(d.result === 'success' && d.data.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  d.data.forEach(r => { html += `<option value="${r[0]}">${r[0]}</option>`; });Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  html = '<option value="" disabled>Kegiatan Kosong (Cek Admin)</option>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('jenisKegiatan').innerHTML = html;Â 
Â  Â  Â  Â  }).catch(e => {
Â  Â  Â  Â  Â  Â  document.getElementById('jenisKegiatan').innerHTML = '<option disabled>Gagal Memuat (Cek Koneksi)</option>';
Â  Â  Â  Â  });Â 
Â  Â  }
Â  Â  function bukaModalKelolaKegiatan() { if(!modalKegiatan) modalKegiatan = new bootstrap.Modal(document.getElementById('modalKelolaKegiatan')); modalKegiatan.show(); loadListKegiatanAdmin(); }
Â  Â  function loadListKegiatanAdmin() { fetchData({ action: 'getKegiatan' }).then(d => { let html = ''; if(d.result === 'success') d.data.forEach(r => { html += `<li class="list-group-item d-flex justify-content-between">${r[0]} <button class="btn btn-sm btn-danger" onclick="hapusKegiatan('${r[0]}')">X</button></li>`; }); document.getElementById('listKegiatan').innerHTML = html; }); }
Â  Â  function tambahKegiatan() { let n = document.getElementById('inputKegiatanBaru').value; if(!n) return; fetchData({ action: 'tambahKegiatan', namaKegiatan: n }).then(d => { if(d.result==='success') { document.getElementById('inputKegiatanBaru').value=''; loadListKegiatanAdmin(); loadKegiatanDropdown(); } }); }
Â  Â  function hapusKegiatan(n) { if(confirm("Hapus?")) fetchData({ action: 'hapusKegiatan', namaKegiatan: n }).then(d => { if(d.result==='success') { loadListKegiatanAdmin(); loadKegiatanDropdown(); } }); }

Â  Â  // --- SUBMIT ABSEN ---
Â  Â  document.getElementById('fotoInput').addEventListener('change', function(e) { let f = e.target.files[0]; if (f) { let r = new FileReader(); r.onload = function(ev) { let i = new Image(); i.onload = function() { let c = document.createElement('canvas'); let x = c.getContext('2d'); let w = i.width, h = i.height, mw = 1000; if (w > mw) { h *= mw / w; w = mw; } c.width = w; c.height = h; x.drawImage(i, 0, 0, w, h); let bh = h * 0.15; if(bh < 60) bh = 60; x.fillStyle = "rgba(0,0,0,0.6)"; x.fillRect(0, h - bh, w, bh); x.fillStyle = "white"; x.font = "bold 14px Arial"; x.fillText(document.getElementById('nama').value, 15, h - bh + 20); x.fillText(new Date().toLocaleString('id-ID'), 15, h - bh + 45); document.getElementById('preview-image').src = c.toDataURL('image/jpeg', 0.8); document.getElementById('preview-container').style.display = 'block'; base64Foto = c.toDataURL('image/jpeg', 0.8).split(',')[1]; }; i.src = ev.target.result; }; r.readAsDataURL(f); } });
Â  Â  document.getElementById('presensiForm').addEventListener('submit', e => { e.preventDefault(); if(!base64Foto) return Swal.fire('Error','Foto Wajib!','warning'); document.getElementById('btnKirim').disabled = true; document.getElementById('loading').style.display = 'block';
Â  Â  Â  Â  let d = { action: 'absen', tanggal: document.getElementById('tanggal').value, jam: document.getElementById('jam').value, nama: document.getElementById('nama').value, kelas: document.getElementById('kelas').value, jabatan: document.getElementById('jabatan').value, jenisKegiatan: document.getElementById('jenisKegiatan').value, keterangan: document.querySelector('input[name="ket"]:checked').value, lokasi: userLat + ", " + userLng, fotoBase64: base64Foto, fotoMimeType: 'image/jpeg', username: localStorage.getItem('osis_username') };
Â  Â  Â  Â  fetchData(d).then(x => { document.getElementById('loading').style.display = 'none'; if (x.result === 'success') { Swal.fire('Berhasil','Data Terkirim','success').then(() => { window.location.reload(); }); } else { Swal.fire('Gagal', x.error, 'error'); } document.getElementById('btnKirim').disabled = false; }).catch(err => { document.getElementById('loading').style.display = 'none'; Swal.fire('Error','Koneksi Gagal','error'); document.getElementById('btnKirim').disabled = false; });
Â  Â  });
</script>
